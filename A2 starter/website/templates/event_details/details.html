{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='Style/EventDetailStyle.css') }}">
{% endblock %}

{% block content %}
<!-- Event image -->
<div class="event-image position-relative">
    <img src="{{ event.image }}" class="d-block w-100">
    <div class="carousel-caption d-flex justify-content-center align-items-center h-100">
        <div class="bg-black bg-opacity-75 text-center" style="padding: 50px; border-radius: 50px">
            <h1>{{ event.title.upper() }}</h1>
        </div>
    </div>
</div>

<!-- Event details -->
<div class="container mt-4">
    <div class="row mb-5">
        <!-- Left Column: Ticket Panel -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Ticket Information</h5>
                    <p><strong>Venue:</strong> {{ event.location }}, {{ event.country.title() }}</p>
                    <p><strong>Date:</strong> {{ event.date.strftime('%d/%m/%Y') if event.date else 'TBA' }}</p>
                    <p><strong>Time:</strong> {{ event.startTime.strftime('%I:%M %p') if event.startTime else 'TBA' }}</p>
                    
                    <!-- Display flash messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <h6>Ticket Types Available:</h6>
                    <div class="accordion" id="ticketAccordion">
                        <!-- Normal Tickets -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingNormal">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNormal" aria-expanded="false" aria-controls="collapseNormal">
                                    Normal Tickets (Available: {{ event.normalAvail if event.normalAvail else 0 }})
                                </button>
                            </h2>
                            <div id="collapseNormal" class="accordion-collapse collapse" aria-labelledby="headingNormal">
                                <div class="accordion-body pb-0">
                                    <p><strong>Ticket Price:</strong> ${{ event.normalPrice if event.normalPrice else 0 }}</p>
                                    {% if event.status == 'Available' and event.normalAvail and event.normalAvail > 0 %}
                                        <p>Standard admission to the event</p>
                                    {% else %}
                                        <button class="btn btn-success" disabled>Sold Out</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- VIP Tickets -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingVip">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVip" aria-expanded="false" aria-controls="collapseVip">
                                    VIP Tickets (Available: {{ event.vipAvail if event.vipAvail else 0 }})
                                </button>
                            </h2>
                            <div id="collapseVip" class="accordion-collapse collapse" aria-labelledby="headingVip">
                                <div class="accordion-body pb-0">
                                    <p><strong>Ticket Price:</strong> ${{ event.vipPrice if event.vipPrice else 0 }}</p>
                                    {% if event.status == 'Available' and event.vipAvail and event.vipAvail > 0 %}
                                        <p>Premium experience with exclusive benefits</p>
                                    {% else %}
                                        <button class="btn btn-success" disabled>Sold Out</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Purchase Form -->
                    {% if event.status == 'Available' and (event.normalAvail > 0 or event.vipAvail > 0) %}
                    <div class="mt-4">
                        <h6>Purchase Tickets</h6>
                        <form method="POST" action="{{ url_for('main.purchase_tickets', event_id=event.eventid) }}">
                            <div class="mb-3">
                                <label class="form-label">Number of Normal Tickets:</label>
                                <input type="number" name="normal_qty" class="form-control" value="0" 
                                       min="0" max="{{ event.normalAvail }}" 
                                       {% if event.normalAvail == 0 %}disabled{% endif %}>
                                <div class="form-text">
                                    Available: {{ event.normalAvail }} tickets
                                    {% if event.normalAvail == 0 %}<span class="text-danger"> - Sold Out</span>{% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Number of VIP Tickets:</label>
                                <input type="number" name="vip_qty" class="form-control" value="0" 
                                       min="0" max="{{ event.vipAvail }}" 
                                       {% if event.vipAvail == 0 %}disabled{% endif %}>
                                <div class="form-text">
                                    Available: {{ event.vipAvail }} tickets
                                    {% if event.vipAvail == 0 %}<span class="text-danger"> - Sold Out</span>{% endif %}
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    Purchase Tickets
                                </button>
                            </div>
                        </form>
                    </div>
                    {% elif event.status != 'Available' %}
                    <div class="alert alert-warning mt-3">
                        This event is no longer available for booking.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Event Details -->
        <div class="col-md-8">
            <div class="card border-0">
                <div class="card-body">
                    <h5 class="card-title">Event Details</h5>
                    <p><strong>Artist:</strong> {{ event.artist }}</p>
                    <p><strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if event.status == 'Available' else 'secondary' }}">
                            {{ event.status }}
                        </span>
                    </p>
                    <p>{{ event.description }}</p>
                    {% if event.tags %}
                    <p><strong>Tags:</strong> {{ event.tags }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comment Section -->
<div class="container">
    <h3>Comments</h3>
    
    <!-- Comment form -->
    {% if current_user.is_authenticated %}
    <form method="POST" action="{{ url_for('main.add_comment', event_id=event.eventid) }}">
        <div class="mb-3">
            <textarea name="comment_text" class="form-control" rows="3" placeholder="Write your comment here..." required></textarea>
        </div>
        <div class="text-end mb-3">
            <button type="submit" class="btn btn-success">Submit Comment</button>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info">
        Please <a href="{{ url_for('auth.login') }}">login</a> to leave a comment.
    </div>
    {% endif %}

    <!-- Comments from database -->
    <div class="my-4">
        {% for comment in event.comments %}
        <div class="card mb-2">
            <div class="card-body d-flex align-items-start">
                <img src="{{ url_for('static', filename='Image/NavBar Icons/account.png') }}" class="rounded-circle me-3" style="width:40px; height:40px">
                <div class="pt-2">
                    <p class="m-0"><strong>{{ comment.user.username }}:</strong> {{ comment.comment }}</p>
                    <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %I:%M %p') }}</small>
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-muted">No comments yet. Be the first to comment!</p>
        {% endfor %}
    </div>
</div>
{% endblock %}